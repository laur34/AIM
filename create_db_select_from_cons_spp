#First, use the big Animalia tsv file from BOLD to obtain lists of families, genera, and species, for which we will obtain nubKeys,
#because these are the numbers in the URLs of the GBIF web pages for each taxon.

cat Animalia_03_02_2021_bold_combined.tsv | cut -f16 > ~/Desktop/learn_rgbif/families.txt

sed -i '/[^[:alnum:]]/d' families.txt

sort -u families.txt > families.nospec.txt
tail -n +2 families.nospec.txt > tmp; mv tmp families.nospec.txt

#Then go in R and run script to download taxa and their nubKeys, using rgbif (learn_rgbif.R).
#Also do this for genera and species (columns of bold tsv file, not shown).

#When they are done downloading, export them.
#May need cleaning.
##V's commads to clean
cat species_nubkeys_ALL_sorted.tsv | perl -pe 's/\w+ \& \w+, \d\d\d\d\t/\t/g' | perl -pe 's/\w+, \d\d\d\d\t/\t/g' | perl -pe 's/\(\w+, \[\d\d\d\d\] \)\t/\t/g' | perl -pe 's/\(\w+, \d\d\d\d\)\t/\t/g' | perl -pe 's/\(\w+\.\w+, \d\d\d\d\)\t/\t/g' | less -S

#Combine them all into one.
cat families_nubkeys.csv genera_nubkeys.csv species_nubkeys_ALL_sorted.csv > taxa_nubkeys.tsv
sed -i 's/"//g' taxa_nubkeys.tsv
sed -i '/\$/d' taxa_nubkeys.tsv
sort -u taxa_nubkeys.tsv > taxa_nubkeys_uniq.tsv
sed -i 's/ /_/g' taxa_nubkeys_uniq.tsv

##############################################################
##create sqlite3 db of species names and nubKeys:
sqlite3 test.db
create table spec_nk(one varchar(70), two longint);
#insert into spec_nk values('Zygothrica parvipoeyi',1560312);
#insert into spec_nk values('Zygoneura contractans',1487024);
#select * from spec_nk;
.separator "\t"
.import species_nubkeys_ALL_sorted.tsv spec_nk


#search consensus species results against it
sqlite3 test.db
.separator "\t"
#SELECT * FROM spec_nk WHERE one IN ($args_list);

sed -i 's/_/ /' rrspec.tsv

args_list=$(cat rrspec.tsv | awk 'NF {printf "\x27%s\x27,", $0}')
args_list=${args_list::-1}

sqlite3 test.db -cmd ".separator \t" "SELECT * FROM spec_nk WHERE one IN ($args_list);" > test.out

#Use the created file of species with nubKeys to create URL list.
sed -i 's/^$//' test.out

while IFS=$'\t' read -r SPP NK; do
    printf 'https://www.gbif.org/species/%s\n' "$NK"
done < test.out
###########################################################
#But this doesn't really help as far as adding the links to the results file.
#New approach, skip the db, and just use the files themselves.
##Combine consensus_Family, genus, and spp cols into one.
cut -f17-19 redlist_reordered_raw.tsv > ccol.tsv
##Make this column to only contain the rightmost values
cat ccol.tsv | perl -pe 's/(\w+)\t\t\n/$1\n/' | perl -pe 's/\w+\t(\w+)\t\n/$1\n/' | perl -pe 's/\w+\t\w+\t(\w+)/$1/' | perl -pe 's/\t+//' > cons_comb.txt

## search for these strings in the taxa_nk file, creating a new column

while read -r line; do
    if [ -z "$line" ]; then
        echo "" >>gbif_col.txt
    else
        (grep "${line}\s" taxa_nubkeys_uniq.tsv || printf "\n") >>gbif_col.txt
    fi
done <cons_comb.txt

#ok but some of the genera and families don't get results, because they have species, but the species didn't have a match.
#2nd pass.
##Create new input combined column from result of first pass, plus original consensus genus column
paste <(cut -f18 redlist_reordered_raw.tsv)  <(cut -f1 gbif_col.txt) >cons_comb2.txt
##Make it only contain the rightmost columns of the two it's made of:
cat cons_comb2.txt | perl -pe 's/\w+\t(\w+)\n/$1\n/' | perl -pe 's/\t//g' > cons_comb2a.txt

## search for these strings in the taxa_nk file, creating a (another) new column
rm gbif_col.txt

while read -r line; do
    if [ -z "$line" ]; then
        echo "" >>gbif_col.txt
    else
        (grep "${line}\s" taxa_nubkeys_uniq.tsv || printf "\n") >>gbif_col.txt
    fi
done <cons_comb2a.txt

#Then, do a third pass, with the result of 2nd pass, and the original families column.
paste <(cut -f17 redlist_reordered_raw.tsv) <(cut -f1 gbif_col.txt) > cons_comb3.txt

cat cons_comb3.txt | perl -pe 's/\w+\t(\w+)\n/$1\n/' | perl -pe 's/\t//g' > cons_comb3a.txt
rm gbif_col.txt

while read -r line; do
    if [ -z "$line" ]; then
        echo "" >>gbif_col.txt
    else
        (grep "${line}\s" taxa_nubkeys_uniq.tsv || printf "\n") >>gbif_col.txt
    fi
done <cons_comb3a.txt

#try how it looks
paste redlist_reordered_raw.tsv gbif_col.txt > redlist_reordered_raw_with_gbif_3rd_pass.tsv

#Last part: create column containing URLs for taxa (s/g/f) which have them, leave blank line if not.
while IFS=$'\t' read nomen nubkey; do
    if [ -z "$nomen" ]; then
        printf "\n" >>gbif_URL_col.txt
    else
        printf 'https://www.gbif.org/species/%s\n' "$nubkey" >>gbif_URL_col.txt
    fi
done <gbif_col.txt

##Problem occurs when multiple matches occur when grepping taxa key file.
##Need to make it unique on the first column (not just one whole line.), e.g. Apamea and ApameaGenN (in original input)
##For now, workaround by taking only lines unique on first column.
sort -u -k1,1 taxa_nubkeys_uniq.tsv > tmp; mv tmp taxa_nubkeys_uniq.tsv
